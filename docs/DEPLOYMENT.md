# Deployment Guide

## Prerequisites

- AWS CLI configured with appropriate permissions
- Docker installed
- Node.js 18+ installed
- Serverless Framework installed: `npm install -g serverless`
- PostgreSQL client installed: `sudo apt-get install postgresql-client` (Ubuntu) or `brew install postgresql` (macOS)

## Local Development

### Quick Start
```bash
# Start all services with local PostgreSQL
docker-compose up -d
```

### Manual Setup
1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Start services individually:**
   ```bash
   # Terminal 1 - Issuance Service
   cd services/issuance && npm run dev

   # Terminal 2 - Verification Service
   cd services/verification && npm run dev
   ```

3. **Test endpoints:**
   ```bash
   # Health checks
   curl http://localhost:3001/health
   curl http://localhost:3002/health

   # Issue credential
   curl -X POST http://localhost:3001/issuance/credentials \
     -H "Content-Type: application/json" \
     -d '{"name":"John Doe","email":"john@example.com","credentialType":"Developer Certificate"}'

   # Verify credential (use ID from above response)
   curl -X POST http://localhost:3002/verification/credentials \
     -H "Content-Type: application/json" \
     -d '{"id":"<credential-id>","name":"John Doe","email":"john@example.com"}'
   ```

## AWS Cloud Deployment

### One-Command Deployment
```bash
# Deploy everything (ECR, RDS, ECS, migrations)
./deploy.sh

# Or with custom parameters
./deploy.sh --stage prod --region us-west-2 --password "MySecurePass123"
```

### Manual Step-by-Step Deployment

1. **Deploy ECR repositories:**
   ```bash
   serverless deploy --config serverless-ecr.yml --stage dev
   ```

2. **Build and push Docker images:**
   ```bash
   cd services/issuance/scripts && ./push_image.sh
   cd ../../verification/scripts && ./push_image.sh
   ```

3. **Deploy infrastructure (RDS + ECS):**
   ```bash
   serverless deploy --stage dev --param="db-password=SimplePass123"
   ```

4. **Run database migrations:**
   ```bash
   ./run-migrations.sh --stage dev --region us-east-1
   ```

5. **Force ECS deployment (if needed):**
   ```bash
   cd services/issuance/scripts && ./deploy_ecs.sh
   cd ../../verification/scripts && ./deploy_ecs.sh
   ```

## Infrastructure Components

### AWS Resources Created
- **ECR Repositories**: `issuance-service`, `verification-service`
- **RDS PostgreSQL**: `kube-credential-backend-dev-postgres` (db.t3.micro)
- **ECS Cluster**: `kube-credential-backend-cluster`
- **ECS Services**: `kube-credential-backend-issuance`, `kube-credential-backend-verification`
- **VPC**: Custom VPC with public subnets
- **Security Groups**: ECS and RDS security groups
- **CloudWatch**: Log groups for each service

### Database Configuration
- **Engine**: PostgreSQL 15
- **Instance**: db.t3.micro (free tier eligible)
- **Username**: `dbadmin`
- **Database**: `kube_credentials`
- **SSL**: Disabled for development (enabled via parameter group)

## Environment Variables

Environment variables are automatically configured in ECS task definitions:

```bash
NODE_ENV=production
PORT=3000
AWS_REGION=us-east-1
DB_NAME=kube_credentials
DB_PORT=5432
RDS_CLUSTER_HOST=<auto-generated-from-rds>
RDS_CLUSTER_USERNAME=dbadmin
RDS_CLUSTER_PASSWORD=<from-deployment-parameter>
```

## Monitoring & Troubleshooting

### Health Checks
```bash
# Check service health
curl https://<ecs-public-ip>:3000/health
```

### Logs
```bash
# View ECS logs
aws logs tail /ecs/kube-credential-backend-issuance --follow
aws logs tail /ecs/kube-credential-backend-verification --follow
```

### Database Connection Test
```bash
# Connect to RDS directly
PGPASSWORD=SimplePass123 psql -h <rds-endpoint> -U dbadmin -d kube_credentials
```

### ECS Service Status
```bash
# Check service status
aws ecs describe-services \
  --cluster kube-credential-backend-cluster \
  --services kube-credential-backend-issuance kube-credential-backend-verification
```

## Scaling

### Horizontal Scaling
```bash
# Scale issuance service
aws ecs update-service \
  --cluster kube-credential-backend-cluster \
  --service kube-credential-backend-issuance \
  --desired-count 3

# Scale verification service
aws ecs update-service \
  --cluster kube-credential-backend-cluster \
  --service kube-credential-backend-verification \
  --desired-count 2
```

### Vertical Scaling
Update `serverless.yml` CPU/Memory values and redeploy:
```yaml
Cpu: 512      # 0.5 vCPU
Memory: 1024  # 1 GB
```

## Cleanup

```bash
# Remove all AWS resources
serverless remove --stage dev
serverless remove --config serverless-ecr.yml --stage dev

# Remove Docker images locally
docker system prune -a
```

## Production Considerations

- Set `PubliclyAccessible: false` for RDS
- Enable `MultiAZ: true` for RDS
- Set `DeletionProtection: true` for RDS
- Use AWS Secrets Manager for database passwords
- Enable SSL/TLS for database connections
- Configure Application Load Balancer for ECS services
- Set up proper IAM roles with minimal permissions
- Enable AWS CloudTrail for audit logging