service: kube-credential-ecs

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}

custom:
  accountId: ${aws:accountId}
  region: ${self:provider.region}
  stage: ${self:provider.stage}

resources:
  Resources:
    # VPC and Networking
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: 10.0.0.0/16
        EnableDnsHostnames: true
        EnableDnsSupport: true
        Tags:
          - Key: Name
            Value: ${self:service}-vpc

    PublicSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.1.0/24
        AvailabilityZone: ${self:provider.region}a
        MapPublicIpOnLaunch: true

    PublicSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.2.0/24
        AvailabilityZone: ${self:provider.region}b
        MapPublicIpOnLaunch: true

    InternetGateway:
      Type: AWS::EC2::InternetGateway

    AttachGateway:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
        VpcId: !Ref VPC
        InternetGatewayId: !Ref InternetGateway

    PublicRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC

    PublicRoute:
      Type: AWS::EC2::Route
      DependsOn: AttachGateway
      Properties:
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway

    PublicSubnetRouteTableAssociation1:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        SubnetId: !Ref PublicSubnet1
        RouteTableId: !Ref PublicRouteTable

    PublicSubnetRouteTableAssociation2:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        SubnetId: !Ref PublicSubnet2
        RouteTableId: !Ref PublicRouteTable

    # Security Groups
    ECSSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for ECS services
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 3000
            ToPort: 3000
            CidrIp: 0.0.0.0/0
          - IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            CidrIp: 0.0.0.0/0

    # ECS Cluster
    ECSCluster:
      Type: AWS::ECS::Cluster
      Properties:
        ClusterName: ${self:service}-cluster
        CapacityProviders:
          - FARGATE
        DefaultCapacityProviderStrategy:
          - CapacityProvider: FARGATE
            Weight: 1

    # ECS Task Execution Role
    ECSTaskExecutionRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: ecs-tasks.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

    # ECS Task Role
    ECSTaskRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: ecs-tasks.amazonaws.com
              Action: sts:AssumeRole

    # CloudWatch Log Groups
    IssuanceLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /ecs/${self:service}-issuance
        RetentionInDays: 7

    VerificationLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /ecs/${self:service}-verification
        RetentionInDays: 7

    # Issuance Service Task Definition
    IssuanceTaskDefinition:
      Type: AWS::ECS::TaskDefinition
      Properties:
        Family: ${self:service}-issuance
        NetworkMode: awsvpc
        RequiresCompatibilities:
          - FARGATE
        Cpu: 256
        Memory: 512
        ExecutionRoleArn: !Ref ECSTaskExecutionRole
        TaskRoleArn: !Ref ECSTaskRole
        ContainerDefinitions:
          - Name: issuance-service
            Image: ${self:custom.accountId}.dkr.ecr.${self:custom.region}.amazonaws.com/issuance-service:latest
            PortMappings:
              - ContainerPort: 3000
                Protocol: tcp
            Environment:
              - Name: NODE_ENV
                Value: production
              - Name: PORT
                Value: "3000"
              - Name: AWS_REGION
                Value: ${self:custom.region}
            LogConfiguration:
              LogDriver: awslogs
              Options:
                awslogs-group: !Ref IssuanceLogGroup
                awslogs-region: ${self:custom.region}
                awslogs-stream-prefix: ecs

    # Verification Service Task Definition
    VerificationTaskDefinition:
      Type: AWS::ECS::TaskDefinition
      Properties:
        Family: ${self:service}-verification
        NetworkMode: awsvpc
        RequiresCompatibilities:
          - FARGATE
        Cpu: 256
        Memory: 512
        ExecutionRoleArn: !Ref ECSTaskExecutionRole
        TaskRoleArn: !Ref ECSTaskRole
        ContainerDefinitions:
          - Name: verification-service
            Image: ${self:custom.accountId}.dkr.ecr.${self:custom.region}.amazonaws.com/verification-service:latest
            PortMappings:
              - ContainerPort: 3000
                Protocol: tcp
            Environment:
              - Name: NODE_ENV
                Value: production
              - Name: PORT
                Value: "3000"
              - Name: AWS_REGION
                Value: ${self:custom.region}
            LogConfiguration:
              LogDriver: awslogs
              Options:
                awslogs-group: !Ref VerificationLogGroup
                awslogs-region: ${self:custom.region}
                awslogs-stream-prefix: ecs

    # ECS Services
    IssuanceService:
      Type: AWS::ECS::Service
      Properties:
        ServiceName: ${self:service}-issuance
        Cluster: !Ref ECSCluster
        TaskDefinition: !Ref IssuanceTaskDefinition
        LaunchType: FARGATE
        DesiredCount: 1
        NetworkConfiguration:
          AwsvpcConfiguration:
            SecurityGroups:
              - !Ref ECSSecurityGroup
            Subnets:
              - !Ref PublicSubnet1
              - !Ref PublicSubnet2
            AssignPublicIp: ENABLED

    VerificationService:
      Type: AWS::ECS::Service
      Properties:
        ServiceName: ${self:service}-verification
        Cluster: !Ref ECSCluster
        TaskDefinition: !Ref VerificationTaskDefinition
        LaunchType: FARGATE
        DesiredCount: 1
        NetworkConfiguration:
          AwsvpcConfiguration:
            SecurityGroups:
              - !Ref ECSSecurityGroup
            Subnets:
              - !Ref PublicSubnet1
              - !Ref PublicSubnet2
            AssignPublicIp: ENABLED

  Outputs:
    ECSCluster:
      Description: ECS Cluster Name
      Value: !Ref ECSCluster

    VPCId:
      Description: VPC ID
      Value: !Ref VPC

    IssuanceServiceName:
      Description: Issuance ECS Service Name
      Value: !Ref IssuanceService

    VerificationServiceName:
      Description: Verification ECS Service Name
      Value: !Ref VerificationService